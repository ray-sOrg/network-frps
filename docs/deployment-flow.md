# FRPS 部署流程图

## 完整 CI/CD 流程

```
┌─────────────────┐    ┌──────────────────┐    ┌─────────────────┐
│   代码提交      │───▶│  GitHub Actions  │───▶│  腾讯云CCR      │
│   (Git Push)    │    │   (自动触发)      │    │  (镜像仓库)      │
└─────────────────┘    └──────────────────┘    └─────────────────┘
                                │                        │
                                ▼                        ▼
                       ┌──────────────────┐    ┌─────────────────┐
                       │  构建Docker镜像  │    │  推送镜像       │
                       │  (Build Image)   │    │  (Push Image)   │
                       └──────────────────┘    └─────────────────┘
                                │                        │
                                ▼                        ▼
                       ┌──────────────────┐    ┌─────────────────┐
                       │  更新K8s配置    │    │  部署到K3s     │
                       │  (Update Config)│    │  (Deploy to K3s)│
                       └──────────────────┘    └─────────────────┘
                                │                        │
                                ▼                        ▼
                       ┌──────────────────┐    ┌─────────────────┐
                       │  健康检查       │    │  服务就绪       │
                       │  (Health Check) │    │  (Service Ready)│
                       └──────────────────┘    └─────────────────┘
```

## 详细步骤说明

### 1. 代码提交阶段

- 开发者推送代码到 GitHub main 分支
- 自动触发 GitHub Actions 工作流

### 2. CI 阶段 (持续集成)

- **代码检出**: 从 GitHub 检出最新代码
- **Docker 构建**: 使用 Dockerfile 构建 FRPS 镜像
- **镜像推送**: 推送到腾讯云容器镜像服务(CCR)
- **标签管理**: 自动生成版本标签

### 3. CD 阶段 (持续部署)

- **配置更新**: 动态更新 Kubernetes 配置文件
- **镜像标签**: 更新 deployment.yaml 中的镜像标签
- **部署应用**: 使用 kubectl apply 部署到 K3s 集群
- **滚动更新**: 执行零停机滚动更新

### 4. 验证阶段

- **健康检查**: 验证 Pod 状态和健康检查
- **服务验证**: 确认 Service 和 Ingress 配置正确
- **日志检查**: 查看应用启动日志
- **功能测试**: 验证 FRPS 服务是否正常工作

## 关键配置点

### GitHub Actions 配置

- 触发条件: push 到 main 分支
- 运行环境: Ubuntu 最新版本
- 主要步骤: 构建、推送、部署、验证

### 腾讯云配置

- 容器镜像服务: ccr.ccs.tencentyun.com
- 镜像仓库: ray321/frps
- 访问凭证: 通过 GitHub Secrets 管理

### K3s 配置

- 集群访问: 通过 kubeconfig
- 命名空间: frps
- 镜像拉取: 使用 tencent-registry-secret

## 自动化特性

### 智能标签

- `latest`: 主分支最新版本
- `main-<commit-sha>`: 基于提交的版本标签
- 自动版本管理

### 零停机部署

- 滚动更新策略
- 健康检查确保服务可用性
- 失败自动回滚

### 配置热更新

- ConfigMap 变更自动检测
- 配置校验和更新
- 支持配置热重载

## 监控和告警

### 部署状态监控

- 构建成功/失败状态
- 部署完成时间
- 服务健康状态

### 日志收集

- 构建日志
- 部署日志
- 应用运行日志

### 错误处理

- 构建失败自动通知
- 部署失败自动回滚
- 服务异常告警

## 扩展性考虑

### 多环境支持

- 开发环境
- 测试环境
- 生产环境

### 多架构支持

- AMD64 (当前)
- ARM64 (未来扩展)
- 多平台镜像

### 安全增强

- 镜像漏洞扫描
- 代码安全检测
- 访问权限控制
