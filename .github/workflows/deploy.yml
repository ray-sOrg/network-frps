name: ğŸš€ Build & Deploy FRPS

on:
  push:
    branches: [main]

# ========================================
# ğŸ”§ é¡¹ç›®é…ç½®å˜é‡ï¼ˆå¤ç”¨åˆ°å…¶ä»–é¡¹ç›®æ—¶åªéœ€ä¿®æ”¹è¿™é‡Œï¼‰
# ========================================
env:
  # é¡¹ç›®åŸºæœ¬ä¿¡æ¯
  PROJECT_NAME: frps
  GITHUB_REPO: ray-sOrg/network-frps

  # é˜¿é‡Œäº‘å®¹å™¨é•œåƒæœåŠ¡é…ç½®
  ACR_REGION: cn-chengdu
  ACR_NAMESPACE: ray321
  ACR_REGISTRY_VPC: registry-vpc.cn-chengdu.aliyuncs.com
  ACR_REGISTRY_PUBLIC: registry.cn-chengdu.aliyuncs.com

  # Kubernetes é…ç½®
  K8S_NAMESPACE: frps
  K8S_DEPLOYMENT_FILE: deployment.yaml

  # éƒ¨ç½²è¶…æ—¶æ—¶é—´ï¼ˆç§’ï¼‰
  ROLLOUT_TIMEOUT: 180

jobs:
  # =============================
  # 1ï¸âƒ£ æ„å»ºé•œåƒå¹¶æ¨é€åˆ°é˜¿é‡Œäº‘ ACR
  # =============================
  build:
    name: ğŸ—ï¸ Build & Push Docker Image
    runs-on: self-hosted

    outputs:
      image: ${{ steps.meta.outputs.image }}
      tag: ${{ steps.meta.outputs.tag }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          repository: ${{ env.GITHUB_REPO }}
          fetch-depth: 1
          ssh-key: ${{ secrets.SSH_PRIVATE_KEY || '' }}

      # ç™»å½•é˜¿é‡Œäº‘ ACR
      - name: Login to Alibaba Cloud Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.ACR_REGISTRY_VPC }}
          username: ${{ secrets.ALICLOUD_USERNAME }}
          password: ${{ secrets.ALICLOUD_PASSWORD }}

      # ç”Ÿæˆé•œåƒæ ‡ç­¾
      - name: Generate image metadata
        id: meta
        run: |
          VPC_IMAGE=${{ env.ACR_REGISTRY_VPC }}/${{ env.ACR_NAMESPACE }}/${{ env.PROJECT_NAME }}
          PUBLIC_IMAGE=${{ env.ACR_REGISTRY_PUBLIC }}/${{ env.ACR_NAMESPACE }}/${{ env.PROJECT_NAME }}
          IMAGE_TAG="build-${GITHUB_RUN_NUMBER}-$(git rev-parse --short HEAD)"

          echo "image=$PUBLIC_IMAGE" >> $GITHUB_OUTPUT
          echo "tag=$IMAGE_TAG" >> $GITHUB_OUTPUT
          echo "vpc_image=$VPC_IMAGE" >> $GITHUB_OUTPUT

          echo "ğŸ·ï¸  é•œåƒæ ‡ç­¾: $IMAGE_TAG"
          echo "ğŸ“¤ æ¨é€åœ°å€: $VPC_IMAGE:$IMAGE_TAG"
          echo "ğŸ“¦ æ‹‰å–åœ°å€: $PUBLIC_IMAGE:$IMAGE_TAG"

      # æ„å»ºå¹¶æ¨é€é•œåƒ
      - name: Build & Push Docker Image
        run: |
          VPC_IMAGE=${{ steps.meta.outputs.vpc_image }}
          IMAGE_TAG=${{ steps.meta.outputs.tag }}

          echo "ğŸ›  æ„å»ºé•œåƒ: $VPC_IMAGE:$IMAGE_TAG"
          docker build -t $VPC_IMAGE:$IMAGE_TAG .

          echo "ğŸ“¤ æ¨é€é•œåƒåˆ°é˜¿é‡Œäº‘ ACR..."
          docker push $VPC_IMAGE:$IMAGE_TAG

          echo "âœ… é•œåƒæ¨é€æˆåŠŸ"

  # =============================
  # 2ï¸âƒ£ éƒ¨ç½²åˆ° Kubernetes é›†ç¾¤
  # =============================
  deploy:
    name: ğŸš€ Deploy to Kubernetes
    runs-on: self-hosted
    needs: build

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          repository: ${{ env.GITHUB_REPO }}
          fetch-depth: 1
          ssh-key: ${{ secrets.SSH_PRIVATE_KEY || '' }}

      # é…ç½® K8s è®¿é—®
      - name: Configure cluster access
        env:
          KUBECONFIG_CONTENT: ${{ secrets.KUBECONFIG }}
        run: |
          mkdir -p $HOME/.kube
          echo "$KUBECONFIG_CONTENT" > $HOME/.kube/config
          chmod 600 $HOME/.kube/config
          echo "KUBECONFIG=$HOME/.kube/config" >> $GITHUB_ENV

          echo "ğŸ” éªŒè¯é›†ç¾¤è¿æ¥..."
          kubectl cluster-info --request-timeout=10s
          echo "âœ… K8s é›†ç¾¤è¿æ¥æˆåŠŸ"

      # åˆ›å»ºé˜¿é‡Œäº‘é•œåƒæ‹‰å–å‡­è¯
      - name: Create ACR Pull Secret
        run: |
          kubectl create namespace ${{ env.K8S_NAMESPACE }} --dry-run=client -o yaml | kubectl apply -f -
          kubectl delete secret aliyun-acr-secret -n ${{ env.K8S_NAMESPACE }} --ignore-not-found=true
          kubectl create secret docker-registry aliyun-acr-secret \
            --docker-server=${{ env.ACR_REGISTRY_PUBLIC }} \
            --docker-username="${{ secrets.ALICLOUD_USERNAME }}" \
            --docker-password="${{ secrets.ALICLOUD_PASSWORD }}" \
            --namespace=${{ env.K8S_NAMESPACE }}
          echo "âœ… é˜¿é‡Œäº‘é•œåƒæ‹‰å–å‡­è¯å·²åˆ›å»º"

      # åˆ›å»º FRP Secrets
      - name: Create FRP Secrets
        run: |
          cat <<EOF | kubectl apply -f -
          apiVersion: v1
          kind: Secret
          metadata:
            name: frps-secret
            namespace: ${{ env.K8S_NAMESPACE }}
          type: Opaque
          stringData:
            dashboard_user: "admin"
            dashboard_pwd: "${{ secrets.FRP_DASHBOARD_PWD }}"
            token: "${{ secrets.FRP_TOKEN }}"
          EOF
          echo "âœ… FRP Secrets å·²åˆ›å»º"

      # æ›¿æ¢é•œåƒå¹¶éƒ¨ç½²
      - name: Apply deployment
        run: |
          IMAGE=${{ needs.build.outputs.image }}
          TAG=${{ needs.build.outputs.tag }}

          sed -i "s|__IMAGE_NAME__|$IMAGE|g" ${{ env.K8S_DEPLOYMENT_FILE }}
          sed -i "s|__IMAGE_TAG__|$TAG|g" ${{ env.K8S_DEPLOYMENT_FILE }}

          echo "ğŸš€ éƒ¨ç½²ç‰ˆæœ¬: $IMAGE:$TAG"
          kubectl apply -f ${{ env.K8S_DEPLOYMENT_FILE }}

      # æ£€æŸ¥éƒ¨ç½²çŠ¶æ€
      - name: Verify rollout & rollback if failed
        run: |
          DEPLOY_NAME=${{ env.PROJECT_NAME }}-deployment
          if kubectl rollout status deployment/$DEPLOY_NAME -n ${{ env.K8S_NAMESPACE }} --timeout=${{ env.ROLLOUT_TIMEOUT }}s; then
            echo "âœ… éƒ¨ç½²æˆåŠŸ"
          else
            echo "âŒ éƒ¨ç½²å¤±è´¥ï¼Œå¼€å§‹å›æ»š..."
            kubectl rollout undo deployment/$DEPLOY_NAME -n ${{ env.K8S_NAMESPACE }}
            echo "ğŸ©¹ å·²å›æ»šåˆ°ä¸Šä¸€ä¸ªç¨³å®šç‰ˆæœ¬"
            exit 1
          fi

      # éƒ¨ç½²å®Œæˆé€šçŸ¥
      - name: Notify Deployment Result
        if: always()
        run: |
          echo "ğŸ“Š Pod çŠ¶æ€:"
          kubectl get pods -n ${{ env.K8S_NAMESPACE }} -o wide
          echo ""
          echo "ğŸ“Š Service çŠ¶æ€:"
          kubectl get svc -n ${{ env.K8S_NAMESPACE }}

      - name: Clean Docker BuildKit cache
        run: |
          rm -f $HOME/.kube/config
          docker builder prune -af
