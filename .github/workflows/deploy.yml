# GitHub Actions å·¥ä½œæµé…ç½®æ–‡ä»¶
# åŠŸèƒ½ï¼šè‡ªåŠ¨æ„å»ºã€æ¨é€Dockeré•œåƒå¹¶éƒ¨ç½²åˆ°è…¾è®¯äº‘K3sé›†ç¾¤
# è§¦å‘æ¡ä»¶ï¼šæ¨é€åˆ°main/masteråˆ†æ”¯æˆ–åˆ›å»ºPull Request

name: Build and Deploy FRPS to K3s

# å®šä¹‰è§¦å‘æ¡ä»¶
on:
  # å½“ä»£ç æ¨é€åˆ°mainæˆ–masteråˆ†æ”¯æ—¶è§¦å‘
  push:
    branches: [main, master]

# å…¨å±€ç¯å¢ƒå˜é‡é…ç½®
env:
  # è…¾è®¯äº‘å®¹å™¨é•œåƒæœåŠ¡åœ°å€
  REGISTRY: ccr.ccs.tencentyun.com
  # é•œåƒåç§°ï¼ˆå‘½åç©ºé—´/ä»“åº“åï¼‰
  IMAGE_NAME: ray321/frps
  # K3sé›†ç¾¤çš„kubeconfigé…ç½®ï¼ˆä»GitHub Secretsè·å–ï¼‰
  KUBE_CONFIG: ${{ secrets.KUBE_CONFIG }}

# å®šä¹‰å·¥ä½œä»»åŠ¡
jobs:
  # æ„å»ºå’Œéƒ¨ç½²ä»»åŠ¡
  build-and-deploy:
    # è¿è¡Œç¯å¢ƒï¼šUbuntuæœ€æ–°ç‰ˆæœ¬
    runs-on: ubuntu-latest

    # ä»»åŠ¡æ‰§è¡Œæ­¥éª¤
    steps:
      # æ­¥éª¤1ï¼šæ£€å‡ºä»£ç 
      # ä»GitHubä»“åº“æ£€å‡ºæœ€æ–°ä»£ç åˆ°å·¥ä½œç›®å½•
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          # æ£€å‡ºæ·±åº¦ï¼šåªè·å–æœ€æ–°çš„æäº¤ï¼Œæé«˜æ„å»ºé€Ÿåº¦
          fetch-depth: 1

      # æ­¥éª¤2ï¼šè®¾ç½®Docker Buildx
      # å¯ç”¨Docker BuildxåŠŸèƒ½ï¼Œæ”¯æŒå¤šå¹³å°æ„å»ºå’Œç¼“å­˜ä¼˜åŒ–
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
        with:
          # å¯ç”¨BuildKitç¼“å­˜ï¼Œæé«˜æ„å»ºé€Ÿåº¦
          buildkitd-flags: --debug

      # æ­¥éª¤3ï¼šç™»å½•è…¾è®¯äº‘å®¹å™¨é•œåƒæœåŠ¡
      # ä½¿ç”¨GitHub Secretsä¸­å­˜å‚¨çš„å‡­è¯ç™»å½•CCR
      - name: Login to Tencent Cloud Container Registry
        uses: docker/login-action@v3
        with:
          # é•œåƒä»“åº“åœ°å€
          registry: ${{ env.REGISTRY }}
          # ç”¨æˆ·åï¼ˆä»Secretsè·å–ï¼‰
          username: ${{ secrets.TENCENT_REGISTRY_USERNAME }}
          # å¯†ç ï¼ˆä»Secretsè·å–ï¼‰
          password: ${{ secrets.TENCENT_REGISTRY_PASSWORD }}

      # æ­¥éª¤4ï¼šæå–é•œåƒå…ƒæ•°æ®
      # è‡ªåŠ¨ç”Ÿæˆé•œåƒæ ‡ç­¾å’Œæ ‡ç­¾ä¿¡æ¯
      - name: Extract metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          # ç›®æ ‡é•œåƒåœ°å€
          images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}
          # æ ‡ç­¾ç­–ç•¥é…ç½®
          tags: |
            # åŸºäºåˆ†æ”¯åçš„æ ‡ç­¾
            type=ref,event=branch
            # åŸºäºPull Requestçš„æ ‡ç­¾
            type=ref,event=pr
            # åŸºäºcommit SHAçš„æ ‡ç­¾ï¼Œæ ¼å¼ï¼šåˆ†æ”¯å-commitå“ˆå¸Œ
            type=sha,prefix={{branch}}-
            # ä¸»åˆ†æ”¯é¢å¤–æ·»åŠ latestæ ‡ç­¾
            type=raw,value=latest,enable={{is_default_branch}}

      # æ­¥éª¤5ï¼šæ„å»ºå¹¶æ¨é€Dockeré•œåƒ
      # ä½¿ç”¨Dockerfileæ„å»ºé•œåƒå¹¶æ¨é€åˆ°CCR
      - name: Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          # æ„å»ºä¸Šä¸‹æ–‡ï¼šå½“å‰ç›®å½•
          context: .
          # ç›®æ ‡å¹³å°ï¼šLinux AMD64
          platforms: linux/amd64
          # å¯ç”¨æ¨é€ï¼šæ„å»ºå®Œæˆåè‡ªåŠ¨æ¨é€åˆ°ä»“åº“
          push: true
          # ä½¿ç”¨å…ƒæ•°æ®æ­¥éª¤ç”Ÿæˆçš„æ ‡ç­¾
          tags: ${{ steps.meta.outputs.tags }}
          # ä½¿ç”¨å…ƒæ•°æ®æ­¥éª¤ç”Ÿæˆçš„æ ‡ç­¾ä¿¡æ¯
          labels: ${{ steps.meta.outputs.labels }}
          # æ„å»ºç¼“å­˜é…ç½®ï¼šä½¿ç”¨GitHub Actionsç¼“å­˜
          cache-from: type=gha
          cache-to: type=gha,mode=max
          # æ„å»ºå‚æ•°ï¼šä¼ é€’Gitæäº¤ä¿¡æ¯
          build-args: |
            BUILD_DATE=${{ github.event.head_commit.timestamp }}
            VCS_REF=${{ github.sha }}
            VERSION=${{ github.ref_name }}

      # æ­¥éª¤6ï¼šè®¾ç½®kubectlå·¥å…·
      # å®‰è£…æœ€æ–°ç‰ˆæœ¬çš„kubectlå‘½ä»¤è¡Œå·¥å…·
      - name: Set up kubectl
        uses: azure/setup-kubectl@v3
        with:
          version: "latest"

      # æ­¥éª¤7ï¼šé…ç½®kubectlè¿æ¥
      # è®¾ç½®kubectlè¿æ¥åˆ°K3sé›†ç¾¤
      - name: Configure kubectl
        run: |
          # å°†base64ç¼–ç çš„kubeconfigè§£ç åˆ°æ–‡ä»¶
          echo "${{ secrets.KUBE_CONFIG }}" | base64 -d > kubeconfig.yaml
          # è®¾ç½®KUBECONFIGç¯å¢ƒå˜é‡
          export KUBECONFIG=kubeconfig.yaml
          # éªŒè¯é›†ç¾¤è¿æ¥
          kubectl cluster-info

      # æ­¥éª¤8ï¼šæ‰§è¡Œéƒ¨ç½²è„šæœ¬
      # ä½¿ç”¨æˆ‘ä»¬åˆ›å»ºçš„deploy.shè„šæœ¬è¿›è¡Œæ™ºèƒ½éƒ¨ç½²
      - name: Execute deployment script
        run: |
          # è®¾ç½®ç¯å¢ƒå˜é‡
          export KUBECONFIG=kubeconfig.yaml
          export REGISTRY="${{ env.REGISTRY }}"
          export IMAGE_NAME="${{ env.IMAGE_NAME }}"
          export IMAGE_TAG="${{ github.sha }}"
          export NAMESPACE="frps"

          # ç»™éƒ¨ç½²è„šæœ¬æ·»åŠ æ‰§è¡Œæƒé™
          chmod +x scripts/deploy.sh

          # æ‰§è¡Œéƒ¨ç½²è„šæœ¬
          ./scripts/deploy.sh

      # æ­¥éª¤9ï¼šéƒ¨ç½²åéªŒè¯
      # éªŒè¯éƒ¨ç½²æ˜¯å¦æˆåŠŸï¼Œæ£€æŸ¥æœåŠ¡çŠ¶æ€
      - name: Post-deployment verification
        run: |
          export KUBECONFIG=kubeconfig.yaml

          # ç­‰å¾…æœåŠ¡å®Œå…¨å°±ç»ª
          log_info "ç­‰å¾…æœåŠ¡å°±ç»ª..."
          sleep 30

          # æ£€æŸ¥PodçŠ¶æ€å’Œå¥åº·æƒ…å†µ
          log_info "æ£€æŸ¥PodçŠ¶æ€:"
          kubectl get pods -n frps -o wide

          # æ£€æŸ¥æœåŠ¡çŠ¶æ€
          log_info "æ£€æŸ¥æœåŠ¡çŠ¶æ€:"
          kubectl get svc -n frps

          # æ£€æŸ¥éƒ¨ç½²çŠ¶æ€
          log_info "æ£€æŸ¥éƒ¨ç½²çŠ¶æ€:"
          kubectl get deployment -n frps

          # æ£€æŸ¥äº‹ä»¶ï¼ˆç”¨äºæ’æŸ¥é—®é¢˜ï¼‰
          log_info "æ£€æŸ¥æœ€è¿‘äº‹ä»¶:"
          kubectl get events -n frps --sort-by='.lastTimestamp' | tail -10

      # æ­¥éª¤10ï¼šåŠŸèƒ½æµ‹è¯•
      # æµ‹è¯•FRPSæœåŠ¡æ˜¯å¦æ­£å¸¸å·¥ä½œ
      - name: Functional testing
        run: |
          export KUBECONFIG=kubeconfig.yaml

          # è·å–Podåç§°
          POD_NAME=$(kubectl get pods -n frps -l app=frps -o jsonpath='{.items[0].metadata.name}')

          # æ£€æŸ¥FRPSè¿›ç¨‹çŠ¶æ€
          log_info "æ£€æŸ¥FRPSè¿›ç¨‹çŠ¶æ€:"
          kubectl exec -n frps $POD_NAME -- ps aux | grep frps

          # æ£€æŸ¥ç«¯å£ç›‘å¬çŠ¶æ€
          log_info "æ£€æŸ¥ç«¯å£ç›‘å¬çŠ¶æ€:"
          kubectl exec -n frps $POD_NAME -- netstat -tlnp

          # æ£€æŸ¥é…ç½®æ–‡ä»¶
          log_info "æ£€æŸ¥é…ç½®æ–‡ä»¶:"
          kubectl exec -n frps $POD_NAME -- cat /etc/frp/frps.ini

      # æ­¥éª¤11ï¼šæ¸…ç†å·¥ä½œ
      # æ¸…ç†ä¸´æ—¶æ–‡ä»¶å’Œæ•æ„Ÿä¿¡æ¯
      - name: Cleanup
        if: always()
        run: |
          # åˆ é™¤kubeconfigæ–‡ä»¶
          rm -f kubeconfig.yaml

          # æ¸…ç†å…¶ä»–ä¸´æ—¶æ–‡ä»¶
          rm -rf .docker

          log_info "æ¸…ç†å·¥ä½œå®Œæˆ"

      # æ­¥éª¤12ï¼šéƒ¨ç½²ç»“æœé€šçŸ¥
      # æ ¹æ®éƒ¨ç½²ç»“æœå‘é€é€šçŸ¥ï¼ˆå¯é€‰ï¼‰
      - name: Deployment notification
        if: always()
        run: |
          if [ "${{ job.status }}" == "success" ]; then
            echo "âœ… FRPSéƒ¨ç½²æˆåŠŸï¼"
            echo "ğŸŒ æœåŠ¡åœ°å€: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ github.sha }}"
            echo "ğŸ“… éƒ¨ç½²æ—¶é—´: $(date)"
          else
            echo "âŒ FRPSéƒ¨ç½²å¤±è´¥ï¼"
            echo "ğŸ” è¯·æ£€æŸ¥GitHub Actionsæ—¥å¿—æ’æŸ¥é—®é¢˜"
          fi
