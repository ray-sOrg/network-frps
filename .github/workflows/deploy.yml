name: ğŸš€ Build & Deploy FRPS

on:
  push:
    branches: [main]

# ========================================
# ğŸ”§ é¡¹ç›®é…ç½®å˜é‡ï¼ˆå¤ç”¨åˆ°å…¶ä»–é¡¹ç›®æ—¶åªéœ€ä¿®æ”¹è¿™é‡Œï¼‰
# ========================================
env:
  # é¡¹ç›®åŸºæœ¬ä¿¡æ¯
  PROJECT_NAME: frps
  GITHUB_REPO: ray-sOrg/network-frps

  # è…¾è®¯äº‘å®¹å™¨é•œåƒæœåŠ¡ TCR é…ç½®
  TCR_REGISTRY: ccr.ccs.tencentyun.com
  TCR_NAMESPACE: ray321

  # Kubernetes é…ç½®
  K8S_NAMESPACE: frps
  K8S_DEPLOYMENT_FILES: "deployment.yaml mp-ingress.yaml cloud-ingress.yaml photo-ingress.yaml"

  # éƒ¨ç½²è¶…æ—¶æ—¶é—´ï¼ˆç§’ï¼‰
  ROLLOUT_TIMEOUT: 180

jobs:
  # =============================
  # 1ï¸âƒ£ æ„å»ºé•œåƒå¹¶æ¨é€åˆ°è…¾è®¯ TCR
  # =============================
  build:
    name: ğŸ—ï¸ Build & Push Docker Image
    runs-on: ubuntu-latest

    outputs:
      image: ${{ steps.meta.outputs.image }}
      tag: ${{ steps.meta.outputs.tag }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          repository: ${{ env.GITHUB_REPO }}
          fetch-depth: 1

      # ç™»å½•è…¾è®¯äº‘ TCR
      - name: Login to Tencent Cloud Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.TCR_REGISTRY }}
          username: ${{ secrets.TCR_USERNAME }}
          password: ${{ secrets.TCR_PASSWORD }}

      # ç”Ÿæˆé•œåƒæ ‡ç­¾
      - name: Generate image metadata
        id: meta
        run: |
          IMAGE=${{ env.TCR_REGISTRY }}/${{ env.TCR_NAMESPACE }}/${{ env.PROJECT_NAME }}
          IMAGE_TAG="build-${GITHUB_RUN_NUMBER}-$(git rev-parse --short HEAD)"

          echo "image=$IMAGE" >> $GITHUB_OUTPUT
          echo "tag=$IMAGE_TAG" >> $GITHUB_OUTPUT

          echo "ğŸ·ï¸  é•œåƒæ ‡ç­¾: $IMAGE_TAG"
          echo "ğŸ“¦ é•œåƒåœ°å€: $IMAGE:$IMAGE_TAG"

      # æ„å»ºå¹¶æ¨é€é•œåƒ
      - name: Build & Push Docker Image
        run: |
          IMAGE=${{ steps.meta.outputs.image }}
          IMAGE_TAG=${{ steps.meta.outputs.tag }}

          echo "ğŸ›  æ„å»ºé•œåƒ: $IMAGE:$IMAGE_TAG"
          docker build -t $IMAGE:$IMAGE_TAG .

          echo "ğŸ“¤ æ¨é€é•œåƒåˆ°è…¾è®¯äº‘ TCR..."
          docker push $IMAGE:$IMAGE_TAG

          echo "âœ… é•œåƒæ¨é€æˆåŠŸ"

  # =============================
  # 2ï¸âƒ£ éƒ¨ç½²åˆ° Kubernetes é›†ç¾¤
  # =============================
  deploy:
    name: ğŸš€ Deploy to Kubernetes
    runs-on: ubuntu-latest
    needs: build

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          repository: ${{ env.GITHUB_REPO }}
          fetch-depth: 1

      # å®‰è£… kubectl
      - name: Install kubectl
        run: |
          if ! command -v kubectl &> /dev/null; then
            curl -LO "https://dl.k8s.io/release/$(curl -L -s https://dl.k8s.io/release/stable.txt)/bin/linux/amd64/kubectl"
            chmod +x kubectl
            mv kubectl /usr/local/bin/
          fi

      # é…ç½® K8s è®¿é—®
      - name: Configure cluster access
        env:
          KUBECONFIG_CONTENT: ${{ secrets.KUBECONFIG }}
        run: |
          mkdir -p $HOME/.kube
          echo "$KUBECONFIG_CONTENT" > $HOME/.kube/config
          chmod 600 $HOME/.kube/config
          echo "KUBECONFIG=$HOME/.kube/config" >> $GITHUB_ENV

          echo "ğŸ” éªŒè¯é›†ç¾¤è¿æ¥..."
          kubectl cluster-info --request-timeout=10s
          echo "âœ… K8s é›†ç¾¤è¿æ¥æˆåŠŸ"

      # åˆ›å»ºè…¾è®¯äº‘ TCR é•œåƒæ‹‰å–å‡­è¯
      - name: Create TCR Pull Secret
        run: |
          kubectl create namespace ${{ env.K8S_NAMESPACE }} --dry-run=client -o yaml | kubectl apply -f -
          kubectl delete secret tencent-tcr-secret -n ${{ env.K8S_NAMESPACE }} --ignore-not-found=true
          kubectl create secret docker-registry tencent-tcr-secret \
            --docker-server=${{ env.TCR_REGISTRY }} \
            --docker-username="${{ secrets.TCR_USERNAME }}" \
            --docker-password="${{ secrets.TCR_PASSWORD }}" \
            --namespace=${{ env.K8S_NAMESPACE }}
          echo "âœ… è…¾è®¯äº‘ TCR é•œåƒæ‹‰å–å‡­è¯å·²åˆ›å»º"

      # åˆ›å»º FRP Secrets
      - name: Create FRP Secrets
        run: |
          cat <<EOF | kubectl apply -f -
          apiVersion: v1
          kind: Secret
          metadata:
            name: frps-secret
            namespace: ${{ env.K8S_NAMESPACE }}
          type: Opaque
          stringData:
            dashboard_user: "admin"
            dashboard_pwd: "${{ secrets.FRP_DASHBOARD_PWD }}"
            token: "${{ secrets.FRP_TOKEN }}"
          EOF
          echo "âœ… FRP Secrets å·²åˆ›å»º"

      # æ›¿æ¢é•œåƒå¹¶éƒ¨ç½²
      - name: Apply deployment
        run: |
          IMAGE=${{ needs.build.outputs.image }}
          TAG=${{ needs.build.outputs.tag }}

          # æ›¿æ¢é•œåƒå ä½ç¬¦
          for file in ${{ env.K8S_DEPLOYMENT_FILES }}; do
            sed -i "s|__IMAGE_NAME__|$IMAGE|g" $file
            sed -i "s|__IMAGE_TAG__|$TAG|g" $file
          done

          echo "ğŸš€ éƒ¨ç½²ç‰ˆæœ¬: $IMAGE:$TAG"
          
          # éƒ¨ç½²æ‰€æœ‰ K8s é…ç½®æ–‡ä»¶
          for file in ${{ env.K8S_DEPLOYMENT_FILES }}; do
            echo "ğŸ“¦ éƒ¨ç½²: $file"
            kubectl apply -f $file
          done

      # æ£€æŸ¥éƒ¨ç½²çŠ¶æ€
      - name: Verify rollout & rollback if failed
        run: |
          DEPLOY_NAME=${{ env.PROJECT_NAME }}-deployment
          if kubectl rollout status deployment/$DEPLOY_NAME -n ${{ env.K8S_NAMESPACE }} --timeout=${{ env.ROLLOUT_TIMEOUT }}s; then
            echo "âœ… éƒ¨ç½²æˆåŠŸ"
          else
            echo "âŒ éƒ¨ç½²å¤±è´¥ï¼Œå¼€å§‹å›æ»š..."
            kubectl rollout undo deployment/$DEPLOY_NAME -n ${{ env.K8S_NAMESPACE }}
            echo "ğŸ©¹ å·²å›æ»šåˆ°ä¸Šä¸€ä¸ªç¨³å®šç‰ˆæœ¬"
            exit 1
          fi

      # éƒ¨ç½²å®Œæˆé€šçŸ¥
      - name: Notify Deployment Result
        if: always()
        run: |
          echo "ğŸ“Š Pod çŠ¶æ€:"
          kubectl get pods -n ${{ env.K8S_NAMESPACE }} -o wide
          echo ""
          echo "ğŸ“Š Service çŠ¶æ€:"
          kubectl get svc -n ${{ env.K8S_NAMESPACE }}

      - name: Clean up
        run: |
          rm -f $HOME/.kube/config
          docker builder prune -af
