# GitHub Actions æ„å»ºä¸“ç”¨å·¥ä½œæµ
# åŠŸèƒ½ï¼šä»…æ„å»ºDockeré•œåƒï¼Œä¸è¿›è¡Œéƒ¨ç½²
# è§¦å‘æ¡ä»¶ï¼šåˆ›å»ºPull Requeståˆ°main/masteråˆ†æ”¯

name: Build FRPS Docker Image (PR)

# å®šä¹‰è§¦å‘æ¡ä»¶
on:
  # å½“åˆ›å»ºPull Requeståˆ°mainæˆ–masteråˆ†æ”¯æ—¶è§¦å‘
  pull_request:
    branches: [main, master]

# å…¨å±€ç¯å¢ƒå˜é‡é…ç½®
env:
  # è…¾è®¯äº‘å®¹å™¨é•œåƒæœåŠ¡åœ°å€
  REGISTRY: ccr.ccs.tencentyun.com
  # é•œåƒåç§°ï¼ˆå‘½åç©ºé—´/ä»“åº“åï¼‰
  IMAGE_NAME: ray321/frps

# å®šä¹‰å·¥ä½œä»»åŠ¡
jobs:
  # ä»…æ„å»ºä»»åŠ¡
  build-only:
    # è¿è¡Œç¯å¢ƒï¼šUbuntuæœ€æ–°ç‰ˆæœ¬
    runs-on: ubuntu-latest

    # ä»»åŠ¡æ‰§è¡Œæ­¥éª¤
    steps:
      # æ­¥éª¤1ï¼šæ£€å‡ºä»£ç 
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          # æ£€å‡ºæ·±åº¦ï¼šåªè·å–æœ€æ–°çš„æäº¤ï¼Œæé«˜æ„å»ºé€Ÿåº¦
          fetch-depth: 1

      # æ­¥éª¤2ï¼šè®¾ç½®Docker Buildx
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
        with:
          # å¯ç”¨BuildKitç¼“å­˜ï¼Œæé«˜æ„å»ºé€Ÿåº¦
          buildkitd-flags: --debug

      # æ­¥éª¤3ï¼šç™»å½•è…¾è®¯äº‘å®¹å™¨é•œåƒæœåŠ¡
      - name: Login to Tencent Cloud Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ secrets.TENCENT_REGISTRY_USERNAME }}
          password: ${{ secrets.TENCENT_REGISTRY_PASSWORD }}

      # æ­¥éª¤4ï¼šæå–é•œåƒå…ƒæ•°æ®
      - name: Extract metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}
          tags: |
            # åŸºäºPull Requestçš„æ ‡ç­¾
            type=ref,event=pr
            # åŸºäºcommit SHAçš„æ ‡ç­¾
            type=sha,prefix=pr-

      # æ­¥éª¤5ï¼šæ„å»ºDockeré•œåƒ
      - name: Build Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          platforms: linux/amd64
          push: false # ä¸æ¨é€ï¼Œä»…æ„å»º
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
          build-args: |
            BUILD_DATE=${{ github.event.head_commit.timestamp }}
            VCS_REF=${{ github.sha }}
            VERSION=${{ github.ref_name }}

      # æ­¥éª¤6ï¼šæ„å»ºç»“æœé€šçŸ¥
      - name: Build result notification
        if: always()
        run: |
          if [ "${{ job.status }}" == "success" ]; then
            echo "âœ… FRPSé•œåƒæ„å»ºæˆåŠŸï¼"
            echo "ğŸ”§ æ„å»ºæ—¶é—´: $(date)"
            echo "ğŸ“ æäº¤ä¿¡æ¯: ${{ github.event.head_commit.message }}"
            echo "ğŸ‘¤ æäº¤è€…: ${{ github.event.head_commit.author.name }}"
          else
            echo "âŒ FRPSé•œåƒæ„å»ºå¤±è´¥ï¼"
            echo "ğŸ” è¯·æ£€æŸ¥æ„å»ºæ—¥å¿—æ’æŸ¥é—®é¢˜"
          fi
